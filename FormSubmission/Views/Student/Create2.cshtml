@model FormSubmission.Models.Entities.Student
@using FormSubmission.Models.Entities

@{
    ViewData["Title"] = "Create Student";
}

<h1>Create Student With JQuery Ajax and Anti-Forgery Token</h1>

<div class="row">
    <div class="col-md-6">
        <form id="createStudentForm">
			<!--  @@ Html.AntiForgeryToken()  Add Anti-Forgery Token -->

            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" id="Name" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Email" class="control-label"></label>
                <input asp-for="Email" class="form-control" id="Email" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Phone" class="control-label"></label>
                <input asp-for="Phone" class="form-control" id="Phone" />
                <span asp-validation-for="Phone" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Major" class="control-label"></label>
                <select asp-for="Major" class="form-control" id="Major" asp-items="Html.GetEnumSelectList<Major>()">
                    <option value="" selected disabled>Select Major</option>
                </select>
                <span asp-validation-for="Major" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Cgpa" class="control-label"></label>
                <input asp-for="Cgpa" class="form-control" id="Cgpa" />
                <span asp-validation-for="Cgpa" class="text-danger"></span>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary" id="submitButton">Create</button>
            </div>
        </form>
    </div>
</div>

<div id="responseMessage"></div>

@section Scripts {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script>
            // Function to serialize form data into JSON
            $.fn.serializeFormJSON = function () {
                var formData = {};
                var formArray = this.serializeArray();
                $.each(formArray, function () {
                    if (formData[this.name]) {
                        if (!Array.isArray(formData[this.name])) {
                            formData[this.name] = [formData[this.name]];
                        }
                        formData[this.name].push(this.value);
                    } else {
                        formData[this.name] = this.value;
                    }
                });
                return formData;
            };

            $(document).ready(function () {
                $('#createStudentForm').on('submit', function (e) {
                    e.preventDefault();

                    // Serialize form data to JSON
                    var formData = $(this).serializeFormJSON();

                    // Get anti-forgery token
                //    var token = $('input[name="__RequestVerificationToken"]').val();

                console.log(JSON.stringify(formData));

                    // AJAX POST request
                    $.ajax({
                        url: '@Url.Action("Create2", "Student")',
                        type: 'POST',
                        contentType: 'application/json', // Send data as JSON
                        // headers: {
                        //     'RequestVerificationToken': token Include anti-forgery token
                        // },
                        data: JSON.stringify(formData), // Convert form data to JSON string
                        success: function (response) {
                            console.log("Success:", response);
                            $('#responseMessage').html('<div class="alert alert-success">Student created successfully!</div>');
                            window.location.href = '/Student/Index'; // Redirect to index page
                        },
                        error: function (xhr) {
                            console.error("Error:", xhr.responseJSON?.message || xhr.responseText);
                            $('#responseMessage').html('<div class="alert alert-danger">' + (xhr.responseJSON?.message || "An error occurred.") + '</div>');
                        }
                    });
                });
            });
        </script>
}
